<!DOCTYPE html>
<html lang="en">
    
    <head>
       <% include ../partials/head %> 
    </head>

    <body>

        <header>
            <% include ../partials/navigation %>
        </header>

        <div class="container">

            <form id="formSettings">

                <div class="form-group">
                    <label for="xi_broker_url">Xively broker URL</label>
                    <input type="text" class="form-control" id="xi_broker_url" placeholder="">
                    <small id="brokerUrlHelp" class="form-text text-muted">broker.xively.com (US) or broker.xively.eu (EU)</small>
                </div>

                <div class="form-group">
                    <label for="xi_broker_port">Xively broker port</label>
                    <input type="text" class="form-control" id="xi_broker_port" placeholder="">
                    <small id="brokerUrlHelp" class="form-text text-muted">8883 or 443 (see: <a href="https://blog.xively.com/announcing-http-support/">Xively blog</a>)</small>
                </div>

                <hr>

                <div class="form-group">
                    <label for="xi_account_id">Xively account ID</label>
                    <input type="text" class="form-control" id="xi_account_id" placeholder="">
                    <small id="accountIdHelp" class="form-text text-muted">The Account ID of the Xively account that data will be sent to</small>
                </div>

                <div class="form-group">
                    <label for="xi_id_username">Xively username</label>
                    <input type="text" class="form-control" id="xi_id_username" placeholder="">
                    <small id="IdUsernameHelp" class="form-text text-muted">This user account will be used to connect to Xively.</small>
                </div>

                <div class="form-group">
                    <label for="xi_id_password">Xively password</label>
                    <input type="password" class="form-control" id="xi_id_password" placeholder="">
                    <small id="IdPasswordHelp" class="form-text text-muted">The password for the user account above</small>
                </div>

                <!--<div class="form-group">
                    <label for="xi_device_id">Xively Proxy Device ID</label>
                    <input type="text" class="form-control" id="xi_device_id" placeholder="">
                    <small id="deviceIdHelp" class="form-text text-muted">This device will be used to connect to the broker and should have the permissions to access all other devices that want to be configured.</small>
                </div>

                <div class="form-group">
                    <label for="xi_device_pw">Xively Proxy Device Password</label>
                    <input type="text" class="form-control" id="xi_device_pw" placeholder="">
                    <small id="devicePwHelp" class="form-text text-muted">The password for the device above</small>
                </div>-->

                <input type="hidden" id="setting_id" value="">
             
                <button type="submit" class="btn btn-primary">Save settings</button>

                </form>

                <br><br>
                <button type="button" id="restartService" class="btn btn-danger">Restart service</button>
        </div> <!--/.container -->
    </body>

    <!-- Latest compiled and minified JavaScript -->
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script>

    <script>

        $(document).ready(function() {
            //alert("here");

            $.ajax("/api/settings", {
                method: "GET",
                contentType: "application/json",
                success: function(settings) {
                    
                    console.log(settings);
                    
                    if (settings != null) {
                        $("#xi_broker_url").val(settings.xi_broker_url);
                        $("#xi_broker_port").val(settings.xi_broker_port);

                        $("#xi_account_id").val(settings.xi_account_id);
                        $("#xi_id_username").val(settings.xi_id_username);
                        $("#xi_id_password").val(settings.xi_id_password);

                        //$("#xi_device_id").val(settings.conn_xi_device_id);
                        //$("#xi_device_pw").val(settings.conn_xi_device_pw);

                        $("#setting_id").val(settings.setting_id);
                    }
                },
                error: function() {
                    // No settings available yet
                    //alert("Settings could not be retrieved.");
                }
            });

            $("#formSettings").submit(function(e) {
                e.preventDefault();
                
                var settings =  {
                    xi_broker_url: $("#xi_broker_url").val(),
                    xi_broker_port: Number($("#xi_broker_port").val()),

                    xi_account_id: $("#xi_account_id").val(),
                    xi_id_username: $("#xi_id_username").val(),
                    xi_id_password: $("#xi_id_password").val(),

                    //conn_xi_device_id: $("#xi_device_id").val(),
                    //conn_xi_device_pw: $("#xi_device_pw").val(),

                    setting_id: Number($("#setting_id").val())
                };

                $.ajax("/api/settings", {
                    method: "PUT",
                    contentType: "application/json",
                    data: JSON.stringify(settings),
                    success: function() {
                        // All done, reload page
                        location.reload();
                    },
                    error: function() {
                        alert("Settings could not be saved");
                    }
                });
            });

            $("#restartService").click(function() {
                $.ajax("api/restart", {
                    type: "GET",
                    success: function( response ) {
                        console.log( response );
                        location.reload();
                    }
                } );
            });

        });

    </script>
</html>